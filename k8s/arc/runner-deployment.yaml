---
# RunnerDeployment with Auto-Scaling
# Auto-generated from .env file
# Generated on: Sat Jan 24 15:08:24 IST 2026

apiVersion: actions.summerwind.dev/v1alpha1
kind: RunnerDeployment
metadata:
  name: gh-runner
  namespace: github-runners
spec:
  replicas: 1
  
  template:
    metadata:
      labels:
        app: github-runner
    spec:
      image: gh-runner:latest
      imagePullPolicy: IfNotPresent
      dockerdWithinRunnerContainer: true
      # Runner scope configuration
      organization: oguz-labs
      
      # Runner labels (used in workflow: runs-on: [self-hosted, ...])
      labels:
        - self-hosted
        - kubernetes
        - on-demand      
      # Ephemeral runners: each runner handles only one job then terminates
      ephemeral: true
      
      # Service account for runner pods
      serviceAccountName: github-runner
      
      # GitHub token from secret
      env:
        - name: GITHUB_TOKEN
          valueFrom:
            secretKeyRef:
              name: github-token
              key: github_token
        - name: DOCKER_INSECURE_REGISTRY
          value: host.docker.internal:8081
      
      # Resource requests and limits
      resources:
        requests:
          cpu: "1"
          memory: "2Gi"
        limits:
          cpu: "2"
          memory: "4Gi"
      
      # Volume mounts for workspace
      volumeMounts:
        - name: work
          mountPath: /runner/_work
      
      volumes:
        - name: work
          emptyDir: {}
      
      # Security context
      securityContext:
        fsGroup: 1000

      # Container overrides
      containers:
        - name: runner
          securityContext:
            privileged: true

---
# Horizontal Runner Autoscaler
apiVersion: actions.summerwind.dev/v1alpha1
kind: HorizontalRunnerAutoscaler
metadata:
  name: gh-runner-autoscaler
  namespace: github-runners
spec:
  scaleTargetRef:
    name: gh-runner
  
  minReplicas: 1
  maxReplicas: 5
  
  metrics:
    - type: PercentageRunnersBusy
      scaleUpThreshold: "0.75"
      scaleDownThreshold: "0.25"
      scaleUpFactor: "2"
      scaleDownFactor: "0.5"
  
  scaleDownDelaySecondsAfterScaleOut: 300

