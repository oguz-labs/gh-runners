# This deployment manifest uses environment variables from install-config.env
# to configure the GitHub runner deployment.
#
# Usage:
#   export $(grep -v '^#' ../../install-config.env | xargs)
#   envsubst < runner-deployment.yaml | kubectl apply -f -
# ...existing code...

---
# RunnerDeployment with Auto-Scaling
# Auto-generated from .env file
# Generated on: Tue Jan 13 16:48:25 IST 2026

apiVersion: actions.summerwind.dev/v1alpha1
kind: RunnerDeployment
metadata:
  name: gh-runner
  namespace: github-runners
spec:
  replicas: ${MIN_REPLICA_COUNT}
  
  template:
    metadata:
      labels:
        app: github-runner
    spec:
      # Custom runner image with kubectl and buildx pre-installed
      image: ${DOCKER_REPOSITORY}
      imagePullPolicy: Always
      
      # Runner scope configuration
      repository: ${REPOSITORY}
      organization: ${ORGANIZATION}
      
      # Runner labels (used in workflow: runs-on: [self-hosted, ...])
      labels:
        - self-hosted
        - kubernetes
        - on-demand
      # Ephemeral runners: each runner handles only one job then terminates
      ephemeral: true
      
      # Service account for runner pods
      serviceAccountName: github-runner
      
      # GitHub token from secret
      env:
        - name: GITHUB_TOKEN
          valueFrom:
            secretKeyRef:
              name: github-token
              key: github_token
        - name: DOCKER_DRIVER
          value: vfs
        - name: TARGET_TYPE
          value: "${TARGET_TYPE}"
        - name: TARGET_NAME
          value: "${TARGET_NAME}"
        - name: MIN_REPLICA_COUNT
          value: "${MIN_REPLICA_COUNT}"
        - name: MAX_REPLICA_COUNT
          value: "${MAX_REPLICA_COUNT}"
      
      # Resource requests and limits
      # from .env: RUNNER_CPU_REQUEST, RUNNER_CPU_LIMIT, RUNNER_MEMORY_REQUEST, RUNNER_MEMORY_LIMIT
      resources:
        requests:
          cpu: "2"
          memory: "2Gi"
        limits:
          cpu: "4"
          memory: "4Gi"
      
      # Volume mounts for workspace
      volumeMounts:
        - name: work
          mountPath: /runner/_work
        - name: docker-lib
          mountPath: /var/lib/docker
        - name: docker-run
          mountPath: /var/run/docker
      
      volumes:
        - name: work
          emptyDir: {}
        - name: docker-lib
          emptyDir: {}
        - name: docker-run
          emptyDir: {}
      
      # Security context
      securityContext:
        fsGroup: 1000
      volumes:
        - name: work
          emptyDir: {}

# Horizontal Runner Autoscaler
apiVersion: actions.summerwind.dev/v1alpha1
kind: HorizontalRunnerAutoscaler
metadata:
  name: gh-runner-autoscaler
  namespace: github-runners
spec:
  scaleTargetRef:
    name: gh-runner
  minReplicas: ${MIN_REPLICA_COUNT}
  maxReplicas: ${MAX_REPLICA_COUNT}
  metrics:
    - type: PercentageRunnersBusy
      scaleUpThreshold: "0.75"
      scaleDownThreshold: "0.25"
      scaleUpFactor: "2"
      scaleDownFactor: "0.5"
  scaleDownDelaySecondsAfterScaleOut: 300
