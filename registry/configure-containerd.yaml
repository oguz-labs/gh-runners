---
# DaemonSet to configure containerd on all nodes to allow insecure registry
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: registry-config
  namespace: kube-system
spec:
  selector:
    matchLabels:
      app: registry-config
  template:
    metadata:
      labels:
        app: registry-config
    spec:
      hostPID: true
      hostNetwork: true
      initContainers:
      - name: configure-containerd
        image: alpine:latest
        command:
        - sh
        - -c
        - |
          # Install required tools
          apk add --no-cache curl
          
          # Create containerd registry config directory
          mkdir -p /etc/containerd/certs.d/docker-registry.registry.svc.cluster.local:5000
          mkdir -p /etc/containerd/certs.d/10.101.193.164:5000
          
          # Configure registry to use HTTP
          cat > /etc/containerd/certs.d/docker-registry.registry.svc.cluster.local:5000/hosts.toml <<EOF
          server = "http://docker-registry.registry.svc.cluster.local:5000"
          
          [host."http://docker-registry.registry.svc.cluster.local:5000"]
            capabilities = ["pull", "resolve", "push"]
            skip_verify = true
          EOF
          
          cat > /etc/containerd/certs.d/10.101.193.164:5000/hosts.toml <<EOF
          server = "http://10.101.193.164:5000"
          
          [host."http://10.101.193.164:5000"]
            capabilities = ["pull", "resolve", "push"]
            skip_verify = true
          EOF
          
          echo "Containerd registry configuration updated"
          
          # Restart containerd to apply changes (if possible)
          if command -v systemctl > /dev/null 2>&1; then
            nsenter -t 1 -m -u -i -n systemctl restart containerd || echo "Could not restart containerd"
          elif command -v service > /dev/null 2>&1; then
            nsenter -t 1 -m -u -i -n service containerd restart || echo "Could not restart containerd"
          else
            echo "Cannot restart containerd automatically. Manual restart may be required."
          fi
        securityContext:
          privileged: true
        volumeMounts:
        - name: containerd-config
          mountPath: /etc/containerd
      containers:
      - name: pause
        image: gcr.io/google_containers/pause:latest
        resources:
          limits:
            memory: 50Mi
          requests:
            cpu: 10m
            memory: 20Mi
      volumes:
      - name: containerd-config
        hostPath:
          path: /etc/containerd
          type: DirectoryOrCreate
